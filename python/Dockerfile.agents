# Secure Agents Service - Lightweight PydanticAI agents with enhanced security
FROM python:3.11-slim

# Install security updates and required tools
RUN apt-get update && apt-get install -y \
    dumb-init \
    gosu \
    && apt-get upgrade -y \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Create non-root user for security
RUN groupadd -r -g 1001 agentuser && \
    useradd -r -u 1001 -g agentuser -s /sbin/nologin -d /app agentuser

WORKDIR /app

# Install dependencies as root
COPY requirements.agents.txt .
RUN pip install --no-cache-dir -r requirements.agents.txt && \
    pip cache purge

# Set ownership of app directory
RUN chown -R agentuser:agentuser /app

# Copy ONLY agents code with proper ownership
# Agents use MCP tools for all operations
COPY --chown=agentuser:agentuser src/agents/ src/agents/
COPY --chown=agentuser:agentuser src/__init__.py src/

# Remove potential security risks
RUN find /app -name "*.pyc" -delete && \
    find /app -name "__pycache__" -type d -exec rm -rf {} + || true

# Set environment variables
ENV PYTHONPATH="/app:$PYTHONPATH"
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Security: NO ML models in agents container!
# Agents use MCP tools for all ML operations

# Expose Agents port
ARG ARCHON_AGENTS_PORT=8052
ENV ARCHON_AGENTS_PORT=${ARCHON_AGENTS_PORT}
EXPOSE ${ARCHON_AGENTS_PORT}

# Health check with non-root user
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD gosu agentuser python -c "import urllib.request; urllib.request.urlopen('http://localhost:${ARCHON_AGENTS_PORT}/health')"

# Security labels
LABEL maintainer="Archon Team" \
      description="Secure Agents Service - Lightweight PydanticAI agents" \
      version="2.0.0" \
      security.scan="enabled" \
      security.non-root="true"

# Use dumb-init and run as non-root user
ENTRYPOINT ["dumb-init", "--"]
CMD ["gosu", "agentuser", "python", "-m", "uvicorn", "src.agents.server:app", "--host", "0.0.0.0", "--port", "${ARCHON_AGENTS_PORT}"]