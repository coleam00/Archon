# Dockerfile.test.multistage - Secure multi-stage build for testing with result extraction
# This version allows extracting test results and coverage reports with enhanced security

# Stage 1: Secure base dependencies
FROM node:20-alpine AS dependencies

# Install build tools and security updates
RUN apk add --no-cache python3 make g++ git dumb-init && \
    apk upgrade --no-cache

# Create non-root user for build stage
RUN addgroup -g 1001 -S builduser && \
    adduser -S -D -H -u 1001 -s /sbin/nologin -G builduser builduser

WORKDIR /app
RUN chown -R builduser:builduser /app

# Switch to non-root user
USER builduser

# Copy package files with proper ownership
COPY --chown=builduser:builduser package*.json ./

# Install dependencies
RUN npm ci --include=dev && npm cache clean --force

# Stage 2: Secure test runner
FROM node:20-alpine AS test-runner

# Install runtime dependencies and security updates
RUN apk add --no-cache git dumb-init && \
    apk upgrade --no-cache

# Create non-root user for test execution
RUN addgroup -g 1001 -S testuser && \
    adduser -S -D -H -u 1001 -s /sbin/nologin -G testuser testuser

WORKDIR /app
RUN chown -R testuser:testuser /app

# Switch to non-root user
USER testuser

# Copy dependencies from previous stage with proper ownership
COPY --from=dependencies --chown=testuser:testuser /app/node_modules ./node_modules

# Copy application code with proper ownership
COPY --chown=testuser:testuser . .

# Remove potential security risks
RUN rm -rf .git .env* || true

# Create output directories with proper permissions
RUN mkdir -p /test-results /coverage

# Set test environment
ENV NODE_ENV=test

# Run tests and save results (with better error handling)
RUN set -e && \
    npm run test:coverage:run || echo "Tests completed with issues" && \
    cp -r public/test-results/* /test-results/ 2>/dev/null || echo "No test results to copy" && \
    cp -r coverage/* /coverage/ 2>/dev/null || echo "No coverage reports to copy"

# Stage 3: Secure results extractor (minimal image with just results)
FROM alpine:latest AS results

# Install security updates
RUN apk upgrade --no-cache

# Create non-root user for results
RUN addgroup -g 1001 -S resultuser && \
    adduser -S -D -H -u 1001 -s /sbin/nologin -G resultuser resultuser

WORKDIR /results
RUN chown -R resultuser:resultuser /results

# Switch to non-root user
USER resultuser

# Copy test results and coverage reports with proper ownership
COPY --from=test-runner --chown=resultuser:resultuser /test-results ./test-results
COPY --from=test-runner --chown=resultuser:resultuser /coverage ./coverage

# Create a summary file
RUN echo "Test results and coverage reports are available in this container" > README.txt && \
    echo "Generated on: $(date)" >> README.txt

# Security labels
LABEL maintainer="Archon Team" \
      description="Secure multi-stage test results container" \
      version="2.0.0" \
      security.scan="enabled" \
      security.non-root="true"

# Default command to list results
CMD ["ls", "-la"]